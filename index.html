<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Tr√°nsitos Astrol√≥gicos</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen">
    <div id="root"></div>
    <script>
let DUMON_INTERPRETACIONES = {};
let EFEMERIDES_COMPLETAS = null;

// Cargar interpretaciones y efem√©rides completas (396 d√≠as)
Promise.all([
    fetch('interpretaciones.json').then(r => r.json()),
    fetch('efemerides_2025_2026.json').then(r => r.json())
])
    .then(([interpretaciones, efemerides]) => {
        DUMON_INTERPRETACIONES = interpretaciones;
        EFEMERIDES_COMPLETAS = efemerides;
        console.log('üìö Interpretaciones cargadas:', Object.keys(DUMON_INTERPRETACIONES).length);
        console.log('üåü Efem√©rides cargadas:', Object.keys(efemerides).length, 'd√≠as');
        console.log('üìÖ Rango:', Object.keys(efemerides)[0], '-', Object.keys(efemerides)[Object.keys(efemerides).length - 1]);
        init();
    })
    .catch(err => {
        console.error('‚ùå Error cargando datos:', err);
        document.getElementById('root').innerHTML = '<div class="text-white text-center p-8">Error cargando datos. Verifica que interpretaciones.json y efemerides_2025_2026.json est√©n disponibles.</div>';
    });

const {useState, useEffect, createElement: e} = React;

// Funci√≥n para obtener efem√©rides del d√≠a actual desde el archivo precargado
async function obtenerEfemeridesReales() {
    const hoy = new Date();
    const fechaStr = hoy.toISOString().split('T')[0]; // Formato YYYY-MM-DD
    
    console.log('üåü Buscando efem√©rides para:', fechaStr);
    
    if (EFEMERIDES_COMPLETAS && EFEMERIDES_COMPLETAS[fechaStr]) {
        console.log('‚úÖ Efem√©rides encontradas en archivo precargado');
        
        // Convertir formato espa√±ol {signo, grado} a ingl√©s {sign, degree}
        const planetasConvertidos = {};
        for (const [planeta, data] of Object.entries(EFEMERIDES_COMPLETAS[fechaStr])) {
            planetasConvertidos[planeta] = {
                sign: data.signo,
                degree: data.grado
            };
        }
        
        console.log('‚úÖ Planetas convertidos:', Object.keys(planetasConvertidos).length);
        return planetasConvertidos;
    }
    
    // Si la fecha exacta no est√°, buscar la m√°s cercana
    const fechas = Object.keys(EFEMERIDES_COMPLETAS || {}).sort();
    
    if (fechas.length > 0) {
        // Buscar fecha m√°s cercana
        const fechaMasCercana = fechas.reduce((prev, curr) => {
            return Math.abs(new Date(curr) - hoy) < Math.abs(new Date(prev) - hoy) ? curr : prev;
        });
        
        console.log('‚ö†Ô∏è  Fecha exacta no encontrada, usando:', fechaMasCercana);
        
        // Convertir formato
        const planetasConvertidos = {};
        for (const [planeta, data] of Object.entries(EFEMERIDES_COMPLETAS[fechaMasCercana])) {
            planetasConvertidos[planeta] = {
                sign: data.signo,
                degree: data.grado
            };
        }
        
        return planetasConvertidos;
    }
    
    console.log('‚ùå No hay efem√©rides disponibles');
    return obtenerEfemeridesDelDia();
}

function parsearAstroSeek(data) {
    // Parsear respuesta de Astro-Seek
    const planetas = {};
    
    if (data.planets) {
        data.planets.forEach(planet => {
            const nombre = traducirNombrePlaneta(planet.name);
            if (nombre) {
                planetas[nombre] = {
                    sign: traducirSigno(planet.sign),
                    degree: parseFloat(planet.degree)
                };
            }
        });
    }
    
    return planetas;
}

function parsearAstronomyAPI(data) {
    // Parsear respuesta de Astronomy API
    // (implementar seg√∫n estructura de respuesta)
    return obtenerEfemeridesDelDia();
}

function parsearSwissEphemeris(html) {
    // Parsear HTML de Swiss Ephemeris
    // (implementar seg√∫n estructura HTML)
    return obtenerEfemeridesDelDia();
}

function traducirNombrePlaneta(nombre) {
    const map = {
        'Sun': 'Sol', 'Moon': 'Luna', 'Mercury': 'Mercurio',
        'Venus': 'Venus', 'Mars': 'Marte', 'Jupiter': 'J√∫piter',
        'Saturn': 'Saturno', 'Uranus': 'Urano', 'Neptune': 'Neptuno',
        'Pluto': 'Plut√≥n'
    };
    return map[nombre];
}

function traducirSigno(signo) {
    const map = {
        'Ari': 'Aries', 'Tau': 'Tauro', 'Gem': 'G√©minis', 'Can': 'C√°ncer',
        'Leo': 'Leo', 'Vir': 'Virgo', 'Lib': 'Libra', 'Sco': 'Escorpio',
        'Sag': 'Sagitario', 'Cap': 'Capricornio', 'Aqu': 'Acuario', 'Pis': 'Piscis',
        'Aries': 'Aries', 'Taurus': 'Tauro', 'Gemini': 'G√©minis', 'Cancer': 'C√°ncer',
        'Virgo': 'Virgo', 'Libra': 'Libra', 'Scorpio': 'Escorpio',
        'Sagittarius': 'Sagitario', 'Capricorn': 'Capricornio', 
        'Aquarius': 'Acuario', 'Pisces': 'Piscis'
    };
    return map[signo] || signo;
}

// Efem√©rides precargadas - ACTUALIZAR MANUALMENTE O CON SCRIPT
function obtenerEfemeridesDelDia() {
    const now = new Date();
    const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 86400000);
    
    // Base: 11 de diciembre 2024
    const baseDia = 346; // d√≠a del a√±o
    const diasDiff = dayOfYear - baseDia;
    
    console.log(`  üìÖ Usando efem√©rides precargadas (base 11 dic 2024 + ${diasDiff} d√≠as)`);
    
    return {
        'Sol': {sign: 'Sagitario', degree: 19.59 + (diasDiff * 0.98)},
        'Luna': {sign: calculaSignoLuna(diasDiff), degree: (14.50 + diasDiff * 13) % 30},
        'Mercurio': {sign: 'Sagitario', degree: (5.38 + diasDiff * 1.5) % 30},
        'Venus': {sign: 'Sagitario', degree: (10.45 + diasDiff * 1.2) % 30},
        'Marte': {sign: 'Sagitario', degree: 25.22 + (diasDiff * 0.5)},
        'J√∫piter': {sign: 'G√©minis', degree: 23.92 + (diasDiff * 0.08)},
        'Saturno': {sign: 'Piscis', degree: 25.27 + (diasDiff * 0.03)},
        'Urano': {sign: 'Tauro', degree: 28.72 + (diasDiff * 0.01)},
        'Neptuno': {sign: 'Piscis', degree: 29.37},
        'Plut√≥n': {sign: 'Acuario', degree: 2.08}
    };
}

function calculaSignoLuna(diasDiff) {
    const signos = ['Leo', 'Virgo', 'Libra', 'Escorpio', 'Sagitario', 'Capricornio', 
                    'Acuario', 'Piscis', 'Aries', 'Tauro', 'G√©minis', 'C√°ncer'];
    const indiceBase = 4; // Leo
    const ciclo = Math.floor(diasDiff / 2.5); // Luna cambia signo cada ~2.5 d√≠as
    return signos[(indiceBase + ciclo) % 12];
}

function AstroTransitDashboard() {
    const [aspects, setAspects] = useState([]);
    const [selectedAspect, setSelectedAspect] = useState(null);
    const [transitPlanets, setTransitPlanets] = useState(null);
    const [loading, setLoading] = useState(true);
    const [ultimaActualizacion, setUltimaActualizacion] = useState(null);
    
    const natalPlanets = {
        'Sol': {sign: 'G√©minis', degree: 23.952},
        'Luna': {sign: 'Capricornio', degree: 9.367},
        'Mercurio': {sign: 'G√©minis', degree: 14.056},
        'Venus': {sign: 'G√©minis', degree: 23.661},
        'Marte': {sign: 'Escorpio', degree: 11.861},
        'J√∫piter': {sign: 'Capricornio', degree: 9.921},
        'Saturno': {sign: 'Escorpio', degree: 10.340},
        'Urano': {sign: 'Sagitario', degree: 11.038},
        'Neptuno': {sign: 'Capricornio', degree: 0.220},
        'Plut√≥n': {sign: 'Escorpio', degree: 29.480},
        'ASC': {sign: 'Sagitario', degree: 29.0},
        'MC': {sign: 'Virgo', degree: 10.0}
    };
    
    const signToDegrees = {
        'Aries': 0, 'Tauro': 30, 'G√©minis': 60, 'C√°ncer': 90,
        'Leo': 120, 'Virgo': 150, 'Libra': 180, 'Escorpio': 210,
        'Sagitario': 240, 'Capricornio': 270, 'Acuario': 300, 'Piscis': 330
    };
    
    const aspectTypes = [
        {name: 'Conjunci√≥n', angle: 0, orb: 8, color: '#FFD700', symbol: '‚òå'},
        {name: 'Sextil', angle: 60, orb: 6, color: '#4CAF50', symbol: '‚öπ'},
        {name: 'Cuadratura', angle: 90, orb: 8, color: '#FF5252', symbol: '‚ñ°'},
        {name: 'Tr√≠gono', angle: 120, orb: 8, color: '#2196F3', symbol: '‚ñ≥'},
        {name: 'Oposici√≥n', angle: 180, orb: 8, color: '#FF6B6B', symbol: '‚òç'}
    ];
    
    const normalizePlanet = (name) => {
        const map = {
            'Sol': 'SOL', 'Luna': 'LUNA', 'Mercurio': 'MERCURIO',
            'Venus': 'VENUS', 'Marte': 'MARTE', 'J√∫piter': 'JUPITER',
            'Saturno': 'SATURNO', 'Urano': 'URANO', 'Neptuno': 'NEPTUNO',
            'Plut√≥n': 'PLUTON'
        };
        return map[name] || name.toUpperCase();
    };
    
    const normalizeAspect = (name) => {
        const map = {
            'Conjunci√≥n': 'CONJUNCION', 'Sextil': 'SEXTIL',
            'Cuadratura': 'CUADRATURA', 'Tr√≠gono': 'TRIGONO',
            'Oposici√≥n': 'OPOSICION'
        };
        return map[name] || name.toUpperCase();
    };
    
    const getAbsoluteDegree = (sign, degree) => signToDegrees[sign] + degree;
    
    const calculateAspect = (deg1, deg2) => {
        let diff = Math.abs(deg1 - deg2);
        if (diff > 180) diff = 360 - diff;
        
        for (let aspect of aspectTypes) {
            if (Math.abs(diff - aspect.angle) <= aspect.orb) {
                return {
                    ...aspect,
                    exactness: Math.abs(diff - aspect.angle),
                    strength: 1 - (Math.abs(diff - aspect.angle) / aspect.orb)
                };
            }
        }
        return null;
    };
    
    const getInterpretation = (transitPlanet, aspectName, natalPlanet) => {
        const tPlanet = normalizePlanet(transitPlanet);
        const aspect = normalizeAspect(aspectName);
        const nPlanet = normalizePlanet(natalPlanet);
        
        const key = `${tPlanet}_${aspect}_${nPlanet}`;
        if (DUMON_INTERPRETACIONES[key]) {
            return DUMON_INTERPRETACIONES[key];
        }
        
        const keyInversa = `${nPlanet}_${aspect}_${tPlanet}`;
        if (DUMON_INTERPRETACIONES[keyInversa]) {
            return DUMON_INTERPRETACIONES[keyInversa];
        }
        
        return `${transitPlanet} en ${aspectName} con ${natalPlanet} natal. Interpretaci√≥n no disponible.`;
    };
    
    const createAspectMatrix = () => {
        if (!transitPlanets) return {};
        
        const matrix = {};
        
        Object.keys(transitPlanets).forEach(tPlanet => {
            matrix[tPlanet] = {};
            Object.keys(natalPlanets).forEach(nPlanet => {
                const tDeg = getAbsoluteDegree(transitPlanets[tPlanet].sign, transitPlanets[tPlanet].degree);
                const nDeg = getAbsoluteDegree(natalPlanets[nPlanet].sign, natalPlanets[nPlanet].degree);
                const aspect = calculateAspect(tDeg, nDeg);
                matrix[tPlanet][nPlanet] = aspect;
            });
        });
        
        return matrix;
    };
    
    useEffect(() => {
        obtenerEfemeridesReales().then(planets => {
            setTransitPlanets(planets);
            setUltimaActualizacion(new Date());
            setLoading(false);
            
            const foundAspects = [];
            
            Object.entries(planets).forEach(([tPlanet, tData]) => {
                Object.entries(natalPlanets).forEach(([nPlanet, nData]) => {
                    const tDeg = getAbsoluteDegree(tData.sign, tData.degree);
                    const nDeg = getAbsoluteDegree(nData.sign, nData.degree);
                    const aspect = calculateAspect(tDeg, nDeg);
                    
                    if (aspect) {
                        foundAspects.push({
                            transitPlanet: tPlanet,
                            natalPlanet: nPlanet,
                            ...aspect,
                            interpretation: getInterpretation(tPlanet, aspect.name, nPlanet)
                        });
                    }
                });
            });
            
            foundAspects.sort((a, b) => b.strength - a.strength);
            setAspects(foundAspects);
        });
    }, []);
    
    if (loading || !transitPlanets) {
        return e('div', { className: 'flex items-center justify-center min-h-screen' },
            e('div', { className: 'text-white text-center' },
                e('div', { className: 'text-6xl mb-4' }, 'üåü'),
                e('p', { className: 'text-2xl mb-2' }, 'Consultando efem√©rides...'),
                e('p', { className: 'text-white/50 text-sm' }, 'Obteniendo posiciones planetarias actuales')
            )
        );
    }
    
    const matrix = createAspectMatrix();
    const transitPlanetNames = Object.keys(transitPlanets);
    const natalPlanetNames = Object.keys(natalPlanets);
    
    return e('div', { className: 'container mx-auto px-4 py-8' },
        e('div', { className: 'bg-white/10 backdrop-blur-lg rounded-3xl p-8 shadow-2xl mb-8' },
            e('h1', { className: 'text-4xl font-bold text-white mb-2 text-center' }, 'Tr√°nsitos Astrol√≥gicos'),
            e('p', { className: 'text-white/70 text-center mb-2' }, 
                `üìÖ ${new Date().toLocaleDateString('es-AR', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}`
            ),
            e('p', { className: 'text-white/50 text-center text-sm mb-8' }, 
                EFEMERIDES_COMPLETAS ? 
                    `üåü Efem√©rides precargadas: 396 d√≠as (Dic 2025 - Dic 2026) ‚Ä¢ Actualizaci√≥n autom√°tica diaria` : 
                    'üåü Efem√©rides actualizadas'
            ),
            e('div', { className: 'bg-purple-800/30 rounded-xl p-4 mb-8 text-center' },
                e('p', { className: 'text-white text-lg font-semibold' }, 
                    `${aspects.length} aspectos activos ‚Ä¢ ‚úÖ ${Object.keys(DUMON_INTERPRETACIONES).length} interpretaciones disponibles`
                )
            ),
            
            e('div', { className: 'bg-purple-800/20 rounded-xl p-6 mb-8 overflow-x-auto' },
                e('h2', { className: 'text-white text-2xl font-bold mb-4 text-center' }, 'Matriz de Aspectos'),
                e('table', { className: 'w-full border-collapse' },
                    e('thead', {},
                        e('tr', {},
                            e('th', { className: 'p-2 text-white/50 text-sm' }, ''),
                            ...transitPlanetNames.map(tPlanet =>
                                e('th', { 
                                    key: tPlanet,
                                    className: 'p-2 text-white font-bold text-sm border-l border-white/10'
                                }, tPlanet)
                            )
                        )
                    ),
                    e('tbody', {},
                        ...natalPlanetNames.map((nPlanet, i) =>
                            e('tr', { key: nPlanet, className: i > 0 ? 'border-t border-white/10' : '' },
                                e('td', { className: 'p-2 text-white font-bold text-sm text-right pr-4' }, nPlanet),
                                ...transitPlanetNames.map(tPlanet => {
                                    const aspect = matrix[tPlanet][nPlanet];
                                    return e('td', {
                                        key: `${tPlanet}-${nPlanet}`,
                                        className: `p-2 text-center border-l border-white/10 cursor-pointer hover:bg-white/10 transition-colors ${aspect ? 'bg-white/5' : ''}`,
                                        onClick: aspect ? () => {
                                            const fullAspect = aspects.find(a => 
                                                a.transitPlanet === tPlanet && a.natalPlanet === nPlanet
                                            );
                                            if (fullAspect) setSelectedAspect(fullAspect);
                                        } : null
                                    },
                                        aspect ? e('span', {
                                            style: { 
                                                color: aspect.color,
                                                fontSize: '1.5rem',
                                                filter: `brightness(${0.7 + aspect.strength * 0.6})`
                                            }
                                        }, aspect.symbol) : e('span', { className: 'text-white/20 text-xs' }, '¬∑')
                                    );
                                })
                            )
                        )
                    )
                ),
                e('div', { className: 'mt-4 flex gap-4 justify-center flex-wrap text-sm' },
                    ...aspectTypes.map(asp =>
                        e('div', { key: asp.name, className: 'flex items-center gap-2' },
                            e('span', { style: { color: asp.color, fontSize: '1.2rem' } }, asp.symbol),
                            e('span', { className: 'text-white/70' }, asp.name)
                        )
                    )
                )
            )
        ),
        
        e('div', { className: 'bg-white/10 backdrop-blur-lg rounded-3xl p-8 shadow-2xl' },
            e('h2', { className: 'text-white text-2xl font-bold mb-6' }, 'Aspectos Activos'),
            e('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4' },
                ...aspects.map((aspect, i) =>
                    e('div', {
                        key: i,
                        className: 'bg-gradient-to-br from-purple-700/40 to-blue-700/40 backdrop-blur p-6 rounded-xl border border-white/20 hover:border-white/40 transition-all cursor-pointer hover:scale-105',
                        onClick: () => setSelectedAspect(aspect)
                    },
                        e('div', { className: 'flex items-center justify-between mb-3' },
                            e('span', { 
                                className: 'text-3xl',
                                style: { color: aspect.color }
                            }, aspect.symbol),
                            e('span', { className: 'text-white/70 text-sm' }, 
                                `${(aspect.strength * 100).toFixed(0)}%`
                            )
                        ),
                        e('h3', { className: 'text-white font-bold text-lg mb-1' }, 
                            `${aspect.transitPlanet} ${aspect.symbol} ${aspect.natalPlanet}`
                        ),
                        e('p', { className: 'text-white/80 text-sm' }, aspect.name),
                        e('p', { className: 'text-white/60 text-xs mt-2' }, 
                            `Exactitud: ${aspect.exactness.toFixed(2)}¬∞`
                        )
                    )
                )
            )
        ),
        
        selectedAspect && e('div', {
            className: 'fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50',
            onClick: () => setSelectedAspect(null)
        },
            e('div', {
                className: 'bg-gradient-to-br from-purple-900 to-blue-900 rounded-3xl p-8 max-w-2xl w-full max-h-[80vh] overflow-y-auto shadow-2xl border border-white/20',
                onClick: (e) => e.stopPropagation()
            },
                e('div', { className: 'flex items-center justify-between mb-6' },
                    e('h3', { className: 'text-2xl font-bold text-white flex items-center gap-3' },
                        e('span', { style: { fontSize: '2rem', color: selectedAspect.color } }, selectedAspect.symbol),
                        `${selectedAspect.transitPlanet} ${selectedAspect.name} ${selectedAspect.natalPlanet}`
                    )
                ),
                e('div', { className: 'bg-white/10 rounded-xl p-6 mb-6' },
                    e('div', { className: 'grid grid-cols-2 gap-4 mb-4 text-sm' },
                        e('div', {},
                            e('p', { className: 'text-white/70 mb-1' }, 'Tr√°nsito:'),
                            e('p', { className: 'text-white font-semibold' }, 
                                `${selectedAspect.transitPlanet} en ${transitPlanets[selectedAspect.transitPlanet].sign} ${transitPlanets[selectedAspect.transitPlanet].degree.toFixed(2)}¬∞`
                            )
                        ),
                        e('div', {},
                            e('p', { className: 'text-white/70 mb-1' }, 'Natal:'),
                            e('p', { className: 'text-white font-semibold' }, 
                                `${selectedAspect.natalPlanet} en ${natalPlanets[selectedAspect.natalPlanet].sign} ${natalPlanets[selectedAspect.natalPlanet].degree.toFixed(2)}¬∞`
                            )
                        )
                    ),
                    e('h4', { className: 'text-white font-semibold mb-3 mt-4' }, 'Interpretaci√≥n de Dumon:'),
                    e('p', { 
                        className: 'text-white/90 leading-relaxed text-base',
                        style: { whiteSpace: 'pre-line' }
                    }, selectedAspect.interpretation)
                ),
                e('button', {
                    className: 'w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-xl transition-colors',
                    onClick: () => setSelectedAspect(null)
                }, 'Cerrar')
            )
        )
    );
}

function init() {
    ReactDOM.render(
        React.createElement(AstroTransitDashboard),
        document.getElementById('root')
    );
}
    </script>
</body>
</html>
